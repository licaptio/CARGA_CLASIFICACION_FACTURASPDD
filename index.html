<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carga de XML - Deuda Limpia PDD</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f7f7f7; }
    h2 { text-align: center; }
    .contenedor {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 15px;
    }
    .panel {
      background: white;
      flex: 1;
      border-radius: 8px;
      padding: 10px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      overflow-y: auto;
      max-height: 400px;
    }
    .panel h3 { text-align: center; color: #00416A; }
    ul { list-style: none; padding: 0; margin: 0; font-size: 13px; }
    li { margin-bottom: 6px; }
    .ok { color: green; }
    .warn { color: orange; }
    .err { color: red; }
    .pending { color: blue; }
    pre {
      background: #111;
      color: #0f0;
      padding: 10px;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h2>Subir CFDI v√°lidos (solo tipo I y receptor PDD031204KL5)</h2>
  <input type="file" id="xmlInput" accept=".xml" multiple>
  <button onclick="procesarArchivos()">Procesar y Subir</button>

  <div class="contenedor">
    <div class="panel">
      <h3>Procesos Supabase</h3>
      <ul id="listaSupabase"></ul>
    </div>
    <div class="panel">
      <h3>Procesos Firebase</h3>
      <ul id="listaFirebase"></ul>
    </div>
  </div>

  <h3>Bit√°cora</h3>
  <pre id="bitacora"></pre>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // === FIREBASE CONFIG ===
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.firebasestorage.app",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // === SUPABASE CONFIG ===
  const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
  const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";

  let archivosDatos = [];

  document.getElementById('xmlInput').addEventListener('change', async function () {
    archivosDatos = [];
    document.getElementById('listaSupabase').innerHTML = '';
    document.getElementById('listaFirebase').innerHTML = '';

    for (const file of this.files) {
      try {
        const text = await file.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, 'application/xml');

        const cfdiNS = "http://www.sat.gob.mx/cfd/4";
        const tfdNS = "http://www.sat.gob.mx/TimbreFiscalDigital";
        const comprobante = xml.getElementsByTagNameNS(cfdiNS, "Comprobante")[0];
        const timbre = xml.getElementsByTagNameNS(tfdNS, "TimbreFiscalDigital")[0];
        const emisor = xml.getElementsByTagNameNS(cfdiNS, "Emisor")[0];
        const receptor = xml.getElementsByTagNameNS(cfdiNS, "Receptor")[0];

        const tipo = comprobante?.getAttribute("TipoDeComprobante");
        const uuid = timbre?.getAttribute("UUID")?.toUpperCase().trim();
        const receptorRFC = receptor?.getAttribute("Rfc")?.toUpperCase().trim();
        const emisorRFC = emisor?.getAttribute("Rfc")?.toUpperCase().trim();
        const razonSocial = emisor?.getAttribute("Nombre");
        const folio = comprobante?.getAttribute("Folio") || '';
        const serie = comprobante?.getAttribute("Serie") || '';
        const total = parseFloat(comprobante?.getAttribute("Total")) || 0;
        const fecha = comprobante?.getAttribute("Fecha");
        const fechaTimbrado = timbre?.getAttribute("FechaTimbrado") || null;

let conceptosDetalle = [];
const conceptos = xml.getElementsByTagNameNS(cfdiNS, "Concepto");

for (let c of conceptos) {

  // --- Datos b√°sicos del concepto ---
  const cantidad = parseFloat(c.getAttribute("Cantidad")) || 0;
  const descripcion = c.getAttribute("Descripcion") || "";
  const codigoSAT = c.getAttribute("ClaveProdServ") || "";
  const valorUnitario = parseFloat(c.getAttribute("ValorUnitario")) || 0;

  // --- Inicializamos impuestos por concepto ---
  let tasaImpuesto = 0;
  let tipoImpuesto = "";

  // --- Nodo impuestos dentro del concepto ---
  const impuestosNodo = c.getElementsByTagNameNS(cfdiNS, "Impuestos")[0];

  if (impuestosNodo) {
    const traslados = impuestosNodo.getElementsByTagNameNS(cfdiNS, "Traslado");

    if (traslados.length > 0) {
      const t = traslados[0];

      tasaImpuesto = parseFloat(t.getAttribute("TasaOCuota")) || 0;

      const impuestoSAT = t.getAttribute("Impuesto"); // 002=IVA, 003=IEPS, 001=ISR

      tipoImpuesto =
        impuestoSAT === "002"
          ? "IVA"
          : impuestoSAT === "003"
          ? "IEPS"
          : impuestoSAT === "001"
          ? "ISR"
          : impuestoSAT;
    }
  }

  // --- Agregar concepto final ---
  conceptosDetalle.push({
    cantidad,
    codigoSAT,
    descripcion,
    costoUnitario: valorUnitario,
    tasaImpuesto,
    tipoImpuesto
  });
}

// üî•üî•üî• AQU√ç VIENE TU ERROR ORIGINAL: TE FALTABA ESTA L√çNEA üî•üî•üî•
archivosDatos.push({
  uuid,
  tipo,
  receptorRFC,
  emisorRFC,
  razonSocial,
  folio,
  serie,
  total,
  fecha,
  fecha_certificacion: fechaTimbrado,
  conceptosDetalle
});

}


  async function procesarArchivos() {
    const supaItems = document.querySelectorAll('#listaSupabase li');
    const fireItems = document.querySelectorAll('#listaFirebase li');

    for (let i = 0; i < archivosDatos.length; i++) {
      const data = archivosDatos[i];
      const itemSupa = supaItems[i].querySelector('span');
      const itemFire = fireItems[i].querySelector('span');
      if (!data.uuid) continue;

if (data.tipo !== 'I' || data.receptorRFC !== 'PDD031204KL5') {
  let motivo = '';
  if (data.tipo !== 'I') motivo += `TipoDeComprobante "${data.tipo}" no es v√°lido. `;
  if (data.receptorRFC !== 'PDD031204KL5') motivo += `RFC receptor "${data.receptorRFC}" no permitido.`;

  itemSupa.textContent = `Rechazado (${motivo})`;
  itemSupa.className = 'err';
  itemFire.textContent = `Rechazado (${motivo})`;
  itemFire.className = 'err';

  logBitacora(`‚ùå Rechazado ${data.uuid}: ${motivo}`);
  continue;
}


      const refFirebase = doc(db, "almacenes/ALMACENCENTRALPDD/entradas", data.uuid);
      const snapFirebase = await getDoc(refFirebase);
      const yaExisteFirebase = snapFirebase.exists();

      const existeSupa = await fetch(`${SUPABASE_URL}/rest/v1/deuda_limpia_pdd?uuid_cfdi=eq.${data.uuid}`, {
        headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
      });
      const yaExisteSupa = await existeSupa.json();

const datosInsert = {
  // ===== COMPROBANTE =====
  version: comprobante.getAttribute("Version"),
  serie: comprobante.getAttribute("Serie") || "",
  folio: comprobante.getAttribute("Folio") || "",
  fecha: comprobante.getAttribute("Fecha"),
  sello: comprobante.getAttribute("Sello"),
  forma_pago: comprobante.getAttribute("FormaPago") || "",
  condiciones_pago: comprobante.getAttribute("CondicionesDePago") || "",
  subtotal: parseFloat(comprobante.getAttribute("SubTotal") || 0),
  descuento: parseFloat(comprobante.getAttribute("Descuento") || 0),
  moneda: comprobante.getAttribute("Moneda") || "",
  tipo_cambio: comprobante.getAttribute("TipoCambio") || "",
  total: parseFloat(comprobante.getAttribute("Total") || 0),
  tipo_comprobante: comprobante.getAttribute("TipoDeComprobante") || "",
  exportacion: comprobante.getAttribute("Exportacion") || "",
  metodo_pago: comprobante.getAttribute("MetodoPago") || "",
  lugar_expedicion: comprobante.getAttribute("LugarExpedicion") || "",
  confirmacion: comprobante.getAttribute("Confirmacion") || null,

  // ===== EMISOR =====
  rfc_emisor: emisor.getAttribute("Rfc"),
  nombre_emisor: emisor.getAttribute("Nombre") || "",
  regimen_fiscal_emisor: emisor.getAttribute("RegimenFiscal") || "",

  // ===== RECEPTOR =====
  rfc_receptor: receptor.getAttribute("Rfc"),
  nombre_receptor: receptor.getAttribute("Nombre") || "",
  domicilio_fiscal_receptor: receptor.getAttribute("DomicilioFiscalReceptor") || "",
  residencia_fiscal: receptor.getAttribute("ResidenciaFiscal") || "",
  num_reg_id_trib: receptor.getAttribute("NumRegIdTrib") || "",
  regimen_fiscal_receptor: receptor.getAttribute("RegimenFiscalReceptor") || "",
  uso_cfdi: receptor.getAttribute("UsoCFDI") || "",

  // ===== IMPUESTOS GLOBALES =====
  total_traslados: impuestosGlobales.totalTraslados,
  total_retenidos: impuestosGlobales.totalRetenidos,
  iva_16: impuestosGlobales.iva16,
  iva_08: impuestosGlobales.iva08,
  iva_exento: impuestosGlobales.ivaExento,
  ieps: impuestosGlobales.ieps,
  isr_retenido: impuestosGlobales.isrRet,

  // ===== TIMBRE =====
  uuid_cfdi: uuid,
  fecha_certificacion: timbre.getAttribute("FechaTimbrado"),
  no_certificado_sat: timbre.getAttribute("NoCertificadoSAT"),
  rfc_prov_certif: timbre.getAttribute("RfcProvCertif"),
  sello_cfd: timbre.getAttribute("SelloCFD"),
  sello_sat: timbre.getAttribute("SelloSAT"),

  // ===== CONCEPTOS =====
  conceptos_detalle: conceptosDetalle, // cada concepto completo

  // ===== COMPLEMENTOS =====
  complementos: complementosDetectados, // XML serializado o JSON

  // ===== ESTADOS OPERATIVOS =====
  factura_pagada: "NO",
  factura_fisicamente: "NO",
  comentario_factura_fisica: "",
  fotos: []
};


      // === SUPABASE ===
      if (yaExisteSupa.length === 0) {
        await fetch(`${SUPABASE_URL}/rest/v1/deuda_limpia_pdd`, {
          method: 'POST',
          headers: {
            apikey: API_KEY,
            Authorization: `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(datosInsert)
        });
        itemSupa.textContent = 'Subido';
        itemSupa.className = 'ok';
        logBitacora(`‚úÖ Subido a Supabase: ${data.uuid}`);
      } else {
        itemSupa.textContent = 'Ya existe';
        itemSupa.className = 'warn';
        logBitacora(`‚ö†Ô∏è Ya exist√≠a en Supabase: ${data.uuid}`);
      }

      // === FIREBASE ===
      if (!yaExisteFirebase) {
        await setDoc(refFirebase, {
          ...datosInsert,
          origen: "SUPABASE",
          estado: "pendiente",
          timestamp: new Date().toISOString()
        });
        itemFire.textContent = 'Guardado';
        itemFire.className = 'ok';
        logBitacora(`‚úÖ Guardado en Firebase: ${data.uuid}`);
      } else {
        itemFire.textContent = 'Ya existe';
        itemFire.className = 'warn';
        logBitacora(`‚ö†Ô∏è Ya exist√≠a en Firebase: ${data.uuid}`);
      }
    }
    logBitacora("‚úÖ Proceso completado");
  }

  function logBitacora(msg) {
    const log = document.getElementById('bitacora');
    log.textContent += `${new Date().toLocaleTimeString()} - ${msg}\n`;
    log.scrollTop = log.scrollHeight;
  }

  window.procesarArchivos = procesarArchivos;
</script>
  <footer style="margin-top: 40px; padding: 10px; text-align: center; font-size: 13px; color: #555; border-top: 1px solid #ccc;">
    ¬© 2025 Deuda Limpia PDD ¬∑ Desarrollado por Gerardo Quezada versi√≥n con bit√°cora dividida
  </footer>
</body>
</html>
